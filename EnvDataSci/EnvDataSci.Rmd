--- 
title: "Introduction to Environmental Data Science"
author: "Heather Kropp"
date: "2024"
site: bookdown::bookdown_site
documentclass: book
bibliography: [book.bib, packages.bib]
# url: your book url like https://bookdown.org/yihui/bookdown
# cover-image: path to the social sharing image like images/cover.jpg
description: |
  "ENVST 325: Environmental Data Science, Hamilton College"
link-citations: yes
github-repo: kroppheather/Intro_EnvDataSci
---
--- 
title: "Introduction to Environmental Data Science"
author: "Heather Kropp"
date: "2024"
site: bookdown::bookdown_site
documentclass: book
bibliography: [book.bib, packages.bib]
# url: your book url like https://bookdown.org/yihui/bookdown
# cover-image: path to the social sharing image like images/cover.jpg
description: |
  "ENVST 325: Environmental Data Science, Hamilton College"
link-citations: yes
github-repo: kroppheather/Intro_EnvDataSci
---

```{r include=FALSE}
# automatically create a bib database for R packages
knitr::write_bib(c(
  .packages(), 'bookdown', 'knitr', 'rmarkdown'
), 'packages.bib')
```

<!--chapter:end:index.Rmd-->


# Introduction

Placeholder


## Course Learning objectives
## License

<!--chapter:end:00-intro.Rmd-->


# Introduction to R Statistical Software and Git

Placeholder


## Learning objectives
## New functions & syntax
## First some terms:
## Setting up a Repository in GitHub
### _Create a repository_
### _Create a personal token for Rstudio Cloud_
## Start a project with version control in Rstudio Cloud
### _Start a project linked with a repository_
### _Rstudio interface_
### _Version control_
### _Commit your first changes to GitHub_
## Intro/Refresher on R
## Variables
### _Vectors_
### _Data frames_

<!--chapter:end:01-introR_git.Rmd-->


# The data deluge: data wrangling in R

Placeholder


## Learning objectives
## New functions & syntax
## The problem: 
### _Flooding and natural disasters_
### _The data: flood stage & stream guage height_ 
## The approach: packages in R
### _Installing packages_
### _Loading packages_
## The approach: data wrangling
### _Reading in data_
### _Parsing date/time_
### _Extracting information from dates_
## _Basic subsetting_
### _Basic plotting_
### _Joining data tables with a common feature_
### _Aggregating data & chaining functions_
### _Filtering data_
## Citations

<!--chapter:end:02-data_wrangling.Rmd-->


# Data visualization in R

Placeholder


## Learning objectives
## New functions & syntax
## The problem: 
### _Communicating about climate change_
### _The data_
## Fundamentals of plotting data
### _1. Representation of data_
### _2. Layout_
### _3. Encoding_
### _4. Simplicity_
## Plotting data in base R
## Plotting in ggplot2
### _Intro to ggplot_
### _Changing colors_
### Exploring different visualizations in ggplot2
### _Violin and box plots_
### _Area and ribbon plots_
### _Labels_
## Conclusions
## Citations

<!--chapter:end:03-data_vis.Rmd-->


# When it rains, it pours. An introduction to data cleaning.

Placeholder


## Learning objectives
## New functions & syntax
## The problem: ensuring reliable data
### _Sensors for weather and microclimate_
##### 1. **sensor:** relates an electrical or chemical property to the conditions of the physical environment (_e.g._ change in voltage or resistance).
##### 2. **datalogger:** records and stores the data. Programs adjust the interval of data records and the nature of each record (_e.g._ averaged over interval versus value at time of observation).
### _Problematic data_
### _The data_
##### 1. There is no heated precipitation sensor. This means that frozen precipitation will not be accurately measured and accumulation can prevent liquid precipitation from being measured until melt.
##### 2. Air temperature in an all-in-one does have the traditional solar radiation shield of louvered plates that allow for air circulation. High accuracy air temperature measurements will also use a fan to aspirate the air around the sensor. Corrections are automatically applied to account for the sensor lacking these features based on wind and solar radiation.
##### 3. Accumulation of snow or ice on the side of the sensor can impact wind measurements.
##### 4. The installation location experiences late afternoon shading by nearby trees. While it accurately describes the solar radiation of the reforestation plot, it does not reflect broader levels of solar radiation experienced outside of that location. 
##### 5. COVID supply chain issues delayed the shipping of bird spike until late June. Bird activity was minimal in the winter, but in May or June it was clear that bird interference was high.
## Cleaning data
### _Removing unreliable data_
### _Creating flags_
### _Creating functions to check data_
## Conclusion

<!--chapter:end:04-qaqc.Rmd-->


# Linear regression, model selection, and prediction in R

Placeholder


## Learning objectives
## New functions & syntax
## The problem: greenhouse gas emssisions from anthropogenic land use
### _The data: greenhouse gases and reservoir characteristics_
## The approach: Linear regression in R
### _Transforming variables_
### _Binary variables_
### _Running a multiple regression_
### _Checking assumptions_
#### _1. Normality_
#### _2-4. Residuals_
### _5. Multicollinearity_
## Model selection
## Predictions
## Conclusions
## Citations

<!--chapter:end:05-reg_select.Rmd-->


# Thirsty crops and water scarcity. An introduction to time series

Placeholder


## Learning objectives
## New functions & syntax
## The problem: Irrigation and water security
### _The data: satellite observations of evapotranspiration_
## The approach: Analyzing and forecasting a time series
### _Setting up a time series data type_
### _Decomposing a time series_
### _Autocorrelation_
### _Autoregressive (AR) models for time series_
### _Forecast future data_
## Conclusions
## Citations

<!--chapter:end:06-time_series.Rmd-->

---
output: 
  html_document:
    theme: yeti
---
# Tracking bugs from space?!?! An introduction to spatial data in R

_by Heather Kropp_
_for ENVST 325: Introduction to Environmental Data Science_
_Hamilton College_


```{css, echo=FALSE}
.book .book-body .page-wrapper .page-inner section.normal pre.colout {
  background-color: #D9EDF7;
}
```


## Learning objectives

1. Work with raster and vector data in R
2. Calcualte NDVI
3. Track spongy moth defioliation with satellite data



## New functions & syntax
`rast`, `stack`, `st_read`, `plotRGB`,`extract`

```{r warning=FALSE,echo=FALSE, message=FALSE}
library(imager)
```

```{r include=FALSE}
knitr::opts_chunk$set(comment = NA, class.output="bg-info",class.output = "colout" )
```
## The problem: monitoring pest outbreaks

Throughout much of the world, insect and fungal pests can be a common disturbance to forests resulting in outcomes like defoliation and death. The spongy moth (	_Lymantria dispar dispar_) is a common pest to the northeastern United states that infests forests and eats the leaf foliage. According the the New York State Department of Environmental Conservation, spongy moths were introduced to the US in the 1800s via a silkworm breeding program.


<center> 
![](/Users/hkropp/Documents/GitHub/Intro_EnvDataSci/EnvDataSci/photos/tutorial07/moth2.jpg){width=50%}

_Source:A Spongy moth consumes leaves. Patrick Reijnders CC3_

</center>

Large outbreaks can defoliate entire forest stands. Deciduous tree leaves can regrow within the summer. This means that the outbreaks are mostly harmless, but successive years of outbreak or outbreaks co-occurring with other stresses like drought may lead to mortality. Outbreaks can also make trees more susceptible to other pests. Evergreen needleleaf trees may have more difficulty regrowing leaves and can be more susceptible to mortality. The installation of barriers and insecticides can help control spongy moth outbreaks. Tracking outbreaks can help inform forest monitoring and multiple sequential years of outbreaks may suggest spongy moth control measures may be warranted. As you can see from the image below, outbreaks can cover large areas of land that can be difficult to quantify from the ground.

<center> 
![](/Users/hkropp/Documents/GitHub/Intro_EnvDataSci/EnvDataSci/photos/tutorial07/Moth_Defoliation_PA.jpg){width=50%}

_An aerial image of spongy moth defoliation in Pennsylvania. Source: Dhalusa CC3_

</center> 


## The data: 

### _Raster data: Sentinel 2 imagery_

Changes in vegetation over large spatial extents can be quantified from satellite imagery. As discussed in class, the reflectance of light in different wavelengths can be used characterize vegetation, water and other features on the land surface. In this activity, you will work with data from the Sentinel 2 satellite. You will work with Bands 2 (blue), 3 (green), 4 (red), and 8 (near-infrared). A lot of satellite image data is stored in a **GeoTiff** format. This format stores the data as an image with additional metadata in the file and includes the geographic information. The `raster` package can be used to read, analyze, and map these images. The `sf` package contains functions for working with vector data. Let's load the packages into the environment:
```{r echo=TRUE, message="hide"}
library(terra)
library(ggplot2)
```

Each image can actually contain multiple images organized in a **stack**. Here, each tiff file contains four images from each band so you will want to read in the file using the `stack` function. In the summer of 2021, a major spongy moth outbreak occurred around Lake George in New York State. There is a pre- and post- outbreak image. Let's read the images in:

```{r eval=FALSE}
# pre outbreak image
pre <- rast("/cloud/project/activity07/ldd_pre.tif")
```

```{r echo=FALSE}

pre <- rast("/Users/hkropp/Documents/GitHub/Intro_EnvDataSci/EnvDataSci/data/chapter07/ldd_pre.tif")

plotRGB(pre, r=3,g=2,b=1, stretch="lin")
```

```{r eval=FALSE}
# post outbreak image
post <- rast("/cloud/project/activity07/ldd_post.tif")
```

```{r echo=FALSE}

post <- rast("/Users/hkropp/Documents/GitHub/Intro_EnvDataSci/EnvDataSci/data/chapter07/ldd_post.tif")

plotRGB(post, r=3,g=2,b=1, stretch="lin")
```

You can view the components of the stack using the `plot` function and set a greyscale using `col` and `grey`. You can see each band plotted:

```{r echo=TRUE, fig.width=12}
plot(pre, col=grey(1:100/100) )

```

Sentinel 2 data is represented as a **digital number** where the actual reflectance is multiplied by 10,000 for each band. Since we are only working with sentinel data, we don't need to convert to an actual reflectance value (0-1 scale).

You can also make a **color composite** using the plotRGB function. By changing the bands, you can make the **false color composites**. The `plotRGB` function uses three bands to make a composite of red, green, blue color in an image. The `scale` argument specifies the maximum data value (255 will be assumed by default because that is a common value for image data). Color contrast can also be added using the `stretch` argument. 

```{r echo=TRUE, fig.width=10}

par(mfrow=c(1,2))

plotRGB(post, r=3,g=2,b=1, # image and bands
        scale=13000, # some urban or clouds can have reflectance > 1
        stretch="lin", # contrast stretch
        main="True color",
        axes=TRUE)
plotRGB(post, r=4,g=3,b=2, # image and bands
        scale=13000,# max data value
        stretch="lin", # contrast stretch
        main="False color",
        axes=TRUE)
```


### _Vector data:_ 

You have been given two areas around Lake George towards the North of the lake and in the central region of the lake to track outbreaks. You would like to use these boundaries in your calculations:

The `terra` package also works with vector data. This includes points, polygons, and lines with attribute table data. The `vect` function loads the data into R:

```{r eval=FALSE}

northBound <- vect("/cloud/project/activity07/north_bound.shp")

midBound <- vect("/cloud/project/activity07/mid_bound.shp")

```

```{r echo=FALSE}
northBound <- vect("/Users/hkropp/Documents/GitHub/Intro_EnvDataSci/EnvDataSci/data/chapter07/north_bound.shp")

midBound <- vect("/Users/hkropp/Documents/GitHub/Intro_EnvDataSci/EnvDataSci/data/chapter07/mid_bound.shp")
```

You can add these polygons to your plot by specifically referring the the `geometry` column and using the `add=TRUE` argument. Here the plot function defaluts to an sf plot. You can also find more arguments like `fill` for working with polygons:

```{r echo=TRUE}
plotRGB(post, r=3,g=2,b=1, stretch="lin")
plot(northBound, border="tomato3", fill=NA, lwd=3, add=TRUE)
plot(midBound, border="royalblue4",fill=NA, lwd=3, add=TRUE)
```


## The approach: NDVI in R

### _NDVI calculations_

Calculations on rasters will be very familar in R. You can directly apply functions and calculations to a raster cell just like you are used with vectors and data frames. If you remember, the **Normalized Difference Vegetation Index** is calculated based on the normalized difference between near infrared and red reflectance. Values of -1 represent water, values of 0 are a non-vegetated surface, and values of 1 are areas of high levels of photosynthesizing vegetation. You can refer to individual bands in a raster stack using double brackets `[[]]`

You can calculate the NDVI for each raster:

```{r echo=TRUE}
#calculate NDVI pre from NIR (4th band) and Red (3rd band)
ndvi_pre <- (pre[[4]]-pre[[3]])/(pre[[4]]+pre[[3]])
#calculate NDVI post
ndvi_post <- (post[[4]]-post[[3]])/(post[[4]]+post[[3]])

par(mfrow=c(1,2))
plot(ndvi_pre)
plot(ndvi_post)
```

You can see the drop in NDVI after the outbreak. We can specifically calculate the difference:

```{r echo=TRUE}
# difference between post and pre ndvi
ndviDiff <- ndvi_post - ndvi_pre
plot(ndviDiff)

```

### _Extract data in a vector geometry_

You can **extract** the raster values that fall within a vector geometry. The value of every pixel that overlaps with the geometry will be returned. Let's extract the NDVI values pre and post for the two polygons. The `extract` function will pull data from out all raster cells that overlaps. When data is extracted from points, you will get a data frame. When data is extracted from lines or polygons, you get a vector stored in a **list** for each feature. A list is a very flexible type of object and it can store multiple items that are different R objects (for example, both a vector and data frame). Here we only have one polygon in our data frame so we can directly refer to the vector using the `[[1]]` syntax. 

```{r echo=TRUE}
# return a vector of cell values from the first polygon
ndvi_North <- extract(ndviDiff,northBound)[[1]]
# return a vector of cell values from the first polygon
ndvi_Mid <- extract(ndviDiff,midBound)[[1]]
```

Let's use ggplot to visualize the data. Let's make a data frame for the two vectors that will integrate with ggplot. You can use the `rep` function to repeat a value. Here it would be helpful to repeat the name of the boundary. The first argument is the data you want to repeat and the second argument is the number of times to repeat it: 

```{r echo=TRUE}

ndviDataframe <- data.frame(location=c(rep("North", length(ndvi_North)),
                                       rep("Mid", length(ndvi_Mid))),
                            ndvi.diff =c(ndvi_North,ndvi_Mid))

```

Let's look at the change in the ndvi. We will ignore outliers here since there are occasionally numerical artifacts from calculating ndvi differences over water or the build environment:

```{r echo=TRUE}
ggplot(data=ndviDataframe,
        aes(x=location,ndvi.diff))+
  geom_boxplot(outlier.shape = NA)+
  ylim(-0.5,0.5)

```

## Conclusions
In 2021, you can see that the spongy moth defoliated much of the immediate area around Lake George. Areas in the north and the south of the lake were hit harder. A boundary of interest at the north of the lake was hit harder than a boundary near the central part of the lake. 

## Citations
NYS DEC. Spongy moth. https://www.dec.ny.gov/animals/83118.html

Data made available by Charles Bettigole at Skidmore College.

<!--chapter:end:07-raster_rs.Rmd-->

